@page "/item/{selectedItemName}"
@using System.ComponentModel.Design
@using System.Reflection.Metadata.Ecma335
@using System.Text.RegularExpressions
@using MudBlazor
@using NorseMythologyIndex.Models
@using NorseMythologyIndex.Services
@inject MythologyService MythologyService
@inject Microsoft.AspNetCore.Components.NavigationManager navigationManager
@inject IScrollManager ScrollManager

<PageTitle>@selectedItemName</PageTitle>
<div class="page-container">
@if (isLoading)
{
    <div class="loading">
        <p>Loading Æsir...</p>
    </div>
}
else if (selectedItem is not null)
{
    <!--
    <div class="Item-detail">
        <h2>@selectedItemName</h2>
        <div class="tags-section">
            @foreach (var tag in selectedItem.Tags)
            {
                <span class="tag">@tag</span>
            }
        </div>
        @foreach (var attestation in selectedItem.Attestations)
        {
            <Attestation attestation="@attestation"></Attestation>
        }
    </div>
    -->
    <MudContainer Style="margin-top: 5rem; margin-left: -17rem; width: 25rem; position: fixed;">
        <MudList T="string">
            <ChildContent>
            @foreach (var attestation in selectedItem.Attestations)
            {
                <button style="text-align: left" onclick="document.getElementById('@RemoveSpecialCharacters(@attestation.Key)').scrollIntoView({behavior:'smooth'})">@attestation.Key</button>
                <MudList T="string">
                    <ChildContent>
                        <MudStack Style="margin: 0 5rem 0 0; padding: 0" Justify="Justify.FlexStart" AlignItems="AlignItems.Start" Spacing="0" >
                        @foreach (var reference in attestation.Value.GetReferences())
                        {
                            <button style="margin-left: 1rem; text-align: left" onclick="document.getElementById('@RemoveSpecialCharacters(@reference.Key)').scrollIntoView({behavior:'smooth'})">· @reference.Key</button>

                        }
                        </MudStack>
                    </ChildContent>
                </MudList>
            }
            </ChildContent>
        </MudList>
    </MudContainer>
    
    <MudContainer Class="attestations-container">
        <MudScrollToTop>
            <MudFab Color="Color.Tertiary" StartIcon="@Icons.Material.Filled.ArrowCircleUp" />
        </MudScrollToTop>
        <!-- Name of the Selected Item -->
        <MudText class="selected-item-name" Typo="Typo.h3">@selectedItemName</MudText>
        <MudList T="string">
            @foreach (var attestation in selectedItem.Attestations)
            {
                <MudListItem class="reference-item" id="@RemoveSpecialCharacters(attestation.Key)" Expanded>
                    <ChildContent>
                        <!-- Name of the main source (Prose Edda/ Poetic Edda) -->
                        <MudText Typo="Typo.h4"><a style="text-decoration: underline" href="@attestation.Value.Link" target="_blank">@attestation.Key</a></MudText>
                        <hr/>
                    </ChildContent>
                    <NestedList>
                        @foreach (var reference in attestation.Value.GetReferences())
                        {
                            <MudListItem id="@RemoveSpecialCharacters(reference.Key)" Class="reference-item" Expanded>
                                <ChildContent>
                                    <!-- Name of Book/Poem -->
                                    <MudText Typo="Typo.h5"> <a style="text-decoration: underline" href="@reference.Value.Link" target="_blank">@reference.Key</a>
                                    </MudText>
                                    <hr/>
                                </ChildContent>
                                <NestedList>
                                    @foreach (var content in reference.Value.GetContents())
                                    {
                                        <!-- Stanza or chapter -->
                                        <MudContainer Style="padding: 0 2rem" Text="@(content.Key + ": " + content.Value.Explanation)">
                                            <ChildContent>
                                                <a style="font-weight: bold; text-decoration: underline" target="_blank" href="@content.Value.Link">@content.Key:</a>
                                                <span>@content.Value.Explanation</span>
                                                @if (!string.IsNullOrEmpty(content.Value.Text))
                                                {
                                                    <p style="white-space: pre-line; margin: 1rem 0; background-color: #f8f9fa; border-radius: 1rem; padding: 1.5rem">@content.Value.Text</p>
                                                }
                                            </ChildContent>
                                        </MudContainer>
                                    }
                                </NestedList>
                            </MudListItem>
                        }
                    </NestedList>
                </MudListItem>
            }
        </MudList>
    </MudContainer>
}
</div>

@code{

    private MythologyItem selectedItem
    {
        get
        {
            if (_mythologyItems.Any())
            {
                return _mythologyItems[selectedItemName];
            }

            return null;
        }
        set
        {
            
        }
    }

    [Parameter] public string selectedItemName { get; set; }
    private Dictionary<string, MythologyItem> _mythologyItems = new();
    public bool isLoading = true;
    protected override async Task OnInitializedAsync()
    {
        _mythologyItems = await MythologyService.GetAllItemsAsync();
        selectedItem = _mythologyItems[selectedItemName];
        isLoading = false;
    }

    public void ScrollToId(string id)
    {
        ScrollManager.ScrollToAsync(id, 1,1,ScrollBehavior.Auto);
    }
    
    public string RemoveSpecialCharacters(string str)
    {
        return Regex.Replace(str, "[^a-zA-Z0-9_.]+", "", RegexOptions.Compiled);
    }
}

<style>
    .reference-item{
        scroll-margin: 4.5rem;
    }
    .attestations-container{
        margin-top: 3rem;
    }
    .selected-item-name{
        padding: 0 1rem;
        margin-bottom: 1rem;
    }
    
    .page-container {
        max-width: 70rem;
        margin: 0 auto;
        padding: 2rem;
        position: relative;
    }

    h1 {
        color: #2c3e50;
        margin-bottom: 2rem;
        font-size: 2.5rem;
    }

    .loading {
        text-align: center;
        padding: 3rem;
        font-size: 1.2rem;
        color: #666;
    }


    .tag {
        background: #3498db;
        color: white;
        padding: 0.25rem 0.75rem;
        border-radius: 12px;
        font-size: 0.8rem;
        margin: 0 0.25rem;

    }

    .Item-detail {
        background: white;
        padding: 3rem;
        border-radius: 8px;
        position: relative;
        margin: auto;
        width: 60rem;
        height: fit-content;
    }
    
    .reference h5 {
        color: #34495e;
        margin-bottom: 0.75rem;
    }

 
    .quote blockquote {
        border-left: 3px solid #95a5a6;
        padding-left: 1rem;
        margin: 1rem 0;
        font-style: italic;
        color: #555;
    }
    
</style>